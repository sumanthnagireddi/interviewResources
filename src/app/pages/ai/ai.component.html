<!-- Mobile overlay -->
<div
  class="fixed inset-0 bg-black/20 backdrop-blur-sm z-40 transition-opacity duration-300 md:hidden"
  [class.opacity-100]="sidebarOpen"
  [class.opacity-0]="!sidebarOpen"
  [class.pointer-events-none]="!sidebarOpen"
  (click)="toggleSidebar()"
></div>

<div class="flex font-sans  h-full bg-white dark:bg-slate-950 transition-colors duration-200">

  <!-- SIDEBAR -->
  <aside
    class="sidebar md:hidden fixed md:relative z-50 h-full flex flex-col border-r border-gray-200 dark:border-slate-700 bg-gradient-to-b from-gray-50 to-gray-100 dark:from-slate-900 dark:to-slate-800 transition-all duration-300 ease-in-out"
    [class.-translate-x-full]="!sidebarOpen"
    [class.translate-x-0]="sidebarOpen"
    style="width: 260px; min-width: 260px;"
    [ngClass]="{'md:translate-x-0': true}"
  >
    <!-- Logo + New Chat -->
    <div class="px-3 pt-4 pb-3 border-b border-gray-200 dark:border-slate-700">
      <button
        class="w-full flex items-center gap-2 px-3 py-2 rounded-xl text-sm text-white font-semibold transition-all duration-200 hover:shadow-lg"
        style="background: linear-gradient(to right, var(--color-accent), var(--color-accent-hover));"
        (click)="newChat()"
      >
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M7 1v12M1 7h12" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg>
        New chat
      </button>
    </div>

    <!-- Search -->
    <div class="px-2.5 pt-2.5 pb-2">
      <div class="relative">
        <svg class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 dark:text-gray-500" width="13" height="13" viewBox="0 0 14 14" fill="none">
          <circle cx="6" cy="6" r="4.5" stroke="currentColor" stroke-width="1.3"/>
          <path d="M9.5 9.5L12.5 12.5" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
        </svg>
        <input
          type="text"
          placeholder="Search..."
          class="w-full bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg py-2 pl-8 pr-3 text-sm text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:border-gray-300 dark:focus:border-slate-600 focus:ring-1 transition-all"
          style="--tw-ring-color: rgb(var(--color-accent-rgb, 199, 123, 75) / 0.2);"
          (input)="searchChats($event)"
        />
      </div>
    </div>

    <!-- Chat History -->
    <div class="flex-1 overflow-y-auto px-2 py-2 scrollbar-thin">
      <ng-container *ngIf="filteredChats.length; else noChats">
        <div
          *ngFor="let chat of filteredChats"
          class="group relative flex items-start gap-2.5 px-3 py-2 rounded-lg cursor-pointer transition-all duration-150 mb-1"
          [ngClass]="{
            'bg-white dark:bg-slate-800 shadow-sm border border-gray-200 dark:border-slate-700': chat.id === activeChatId,
            'hover:bg-gray-100 dark:hover:bg-slate-800': chat.id !== activeChatId
          }"
          (click)="loadChat(chat.id)"
        >
          <svg class="mt-0.5 shrink-0" [style.color]="chat.id === activeChatId ? 'var(--color-accent)' : '#9ca3af'" width="13" height="13" viewBox="0 0 14 14" fill="none">
            <path d="M2 2.5C2 1.95 2.45 1.5 3 1.5h8c.55 0 1 .45 1 1v7c0 .55-.45 1-1 1H4.5L2 12V2.5z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round"/>
          </svg>
          <div class="flex-1 min-w-0">
            <p class="text-sm text-gray-900 dark:text-gray-100 truncate" [class.font-medium]="chat.id === activeChatId">{{ chat.title }}</p>
            <p class="text-[11px] text-gray-600 dark:text-gray-400 mt-0.5">{{ chat.messages.length }} msg</p>
          </div>
          <button
            class="opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-gray-400 dark:text-gray-500 hover:text-red-500 dark:hover:text-red-400 shrink-0"
            (click)="deleteChat($event, chat.id)"
          >
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 2l8 8M10 2L2 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </button>
        </div>
      </ng-container>
      <ng-template #noChats>
        <div class="text-center py-12 px-4">
          <svg class="mx-auto mb-3 text-gray-300 dark:text-slate-700" width="28" height="28" viewBox="0 0 28 28" fill="none">
            <path d="M4 5C4 3.9 4.9 3 6 3h16c1.1 0 2 .9 2 2v14c0 1.1-.9 2-2 2H9L4 24V5z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          </svg>
          <p class="text-xs text-gray-500 dark:text-gray-400">No chats yet</p>
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Start above</p>
        </div>
      </ng-template>
    </div>

    <!-- Footer -->
    <div class="px-3 py-2.5 border-t border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-900">
      <p class="text-[10px] text-gray-500 dark:text-gray-400 text-center tracking-wide">Aria AI</p>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <div class="flex-1 flex flex-col h-full min-w-0">

    <!-- Header -->
    <header class="flex items-center justify-between px-4 md:px-6 py-3 bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-700 flex-shrink-0 transition-colors duration-200">
      <div class="flex items-center gap-3">
        <button
          class="md:hidden p-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-800 text-gray-600 dark:text-gray-400 transition-colors"
          (click)="toggleSidebar()"
        >
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
            <path d="M2 4.5h14M2 9h14M2 13.5h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </button>
        <span class="text-gray-900 dark:text-gray-100 text-[14px] font-semibold truncate max-w-[200px] md:max-w-none">{{ chatTitle }}</span>
      </div>
      <div class="flex items-center gap-2">
        <div *ngIf="isGenerating" class="flex items-center gap-1.5 text-[12px] font-medium" style="color: var(--color-accent);">
          <span class="flex gap-0.5">
            <span class="w-1 h-1 bg-current rounded-full animate-pulse"></span>
            <span class="w-1 h-1 bg-current rounded-full animate-pulse"></span>
            <span class="w-1 h-1 bg-current rounded-full animate-pulse"></span>
          </span>
          AI thinking
        </div>
      </div>
    </header>

    <!-- Messages Area -->
    <div class="flex-1 overflow-y-auto scrollbar-thin bg-white dark:bg-slate-950 transition-colors duration-200" #messageContainer>

      <!-- Welcome Screen -->
      <div *ngIf="!activeChatId" class="flex flex-col items-center justify-center h-full px-4 text-center py-10">
        <div>
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-[#c97b4b]/10 to-[#b56d3f]/10 mb-6">
            <svg class="w-8 h-8 text-[#c97b4b]" viewBox="0 0 48 48" fill="none">
              <circle cx="24" cy="24" r="20" stroke="currentColor" stroke-width="1.5" opacity="0.3"/>
              <path d="M24 16v16M20 20h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <h1 class="text-3xl md:text-4xl text-[#2d2621] mb-2 font-semibold">
            Hello<span class="text-[#c97b4b]">.</span>
          </h1>
          <p class="text-[#9e9188] text-sm md:text-base max-w-sm mx-auto leading-relaxed mb-6">Let's explore together. Ask me anything or pick a suggestion below.</p>
        </div>
        <div class="flex flex-wrap gap-2 justify-center max-w-2xl">
          <button
            *ngFor="let s of suggestions"
            class="px-4 py-2 text-sm text-[#2d2621] bg-white border border-[#e0dbd2] rounded-xl hover:border-[#c97b4b] hover:bg-[#faf8f5] hover:shadow-md transition-all duration-200"
            (click)="useSuggestion(s)"
          >{{ s }}</button>
        </div>
      </div>

      <!-- Chat Messages -->
      <div *ngIf="activeChatId" class="w-full max-w-4xl mx-auto px-4 md:px-6 py-6 space-y-4">
        <div
          *ngFor="let msg of currentMessages"
          class="flex gap-3 animate-fade-in"
          [ngClass]="{'justify-end': msg.role === 'user'}"
        >
          <div *ngIf="msg.role === 'assistant'" class="shrink-0 mt-1">
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-[#c97b4b]/20 to-[#b56d3f]/20 border border-[#c97b4b]/30 flex items-center justify-center">
              <svg width="14" height="14" viewBox="0 0 22 22" fill="none" class="text-[#c97b4b]">
                <circle cx="11" cy="11" r="9" stroke="currentColor" stroke-width="1.5" opacity="0.4"/>
                <circle cx="11" cy="11" r="3" fill="currentColor" opacity="0.6"/>
              </svg>
            </div>
          </div>
          <div *ngIf="msg.role === 'assistant'"
            class="flex-1 min-w-0 prose-aria text-[#2d2621] leading-relaxed text-[14px] max-w-2xl"
            [innerHTML]="renderMarkdown(msg.content)"
          ></div>
          <div *ngIf="msg.role === 'user'"
            class="max-w-xs md:max-w-md bg-gradient-to-br from-[#c97b4b] to-[#b56d3f] text-white px-4 py-2.5 rounded-2xl rounded-tr-sm text-[14px] leading-relaxed shadow-md"
          >{{ msg.content }}</div>
        </div>

        <!-- Typing indicator -->
        <div *ngIf="isGenerating" class="flex gap-3 animate-fade-in">
          <div class="shrink-0 mt-1">
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-[#c97b4b]/20 to-[#b56d3f]/20 border border-[#c97b4b]/30 flex items-center justify-center">
              <svg width="14" height="14" viewBox="0 0 22 22" fill="none" class="text-[#c97b4b]">
                <circle cx="11" cy="11" r="9" stroke="currentColor" stroke-width="1.5" opacity="0.4"/>
                <circle cx="11" cy="11" r="3" fill="currentColor" opacity="0.6"/>
              </svg>
            </div>
          </div>
          <div class="flex items-center gap-1 py-2 px-3 rounded-full bg-[#f5f0ea]">
            <span class="w-1.5 h-1.5 bg-[#c97b4b] rounded-full animate-bounce" style="animation-delay: 0ms; opacity: 0.8"></span>
            <span class="w-1.5 h-1.5 bg-[#c97b4b] rounded-full animate-bounce" style="animation-delay: 150ms; opacity: 0.8"></span>
            <span class="w-1.5 h-1.5 bg-[#c97b4b] rounded-full animate-bounce" style="animation-delay: 300ms; opacity: 0.8"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="flex-shrink-0 px-4 md:px-6 py-3 bg-white border-t border-[#e0dbd2]/30">
      <div class="max-w-4xl mx-auto">
        <div class="bg-[#f9f7f4] border border-[#e0dbd2] rounded-xl overflow-hidden transition-all duration-200 focus-within:border-[#c97b4b] focus-within:shadow-lg focus-within:shadow-[#c97b4b]/10">

          <!-- Textarea -->
          <div class="px-4 pt-3 pb-1">
            <textarea
              [(ngModel)]="userInput"
              rows="1"
              class="w-full resize-none bg-transparent text-[#2d2621] text-[14px] leading-relaxed placeholder-[#a89e94] focus:outline-none focus:ring-0 border-0 min-h-[24px] max-h-[120px]"
              placeholder="Ask me anything..."
              (keydown.enter)="handleEnter($event)"
              (input)="autoResize($event)"
            ></textarea>
          </div>

          <!-- Toolbar -->
          <div class="flex items-center justify-between px-3 pb-3 pt-1">
            <button class="w-7 h-7 flex items-center justify-center rounded-lg text-[#9e9188] hover:text-[#c97b4b] hover:bg-white/60 transition-all duration-150">
              <svg width="15" height="15" viewBox="0 0 15 15" fill="none">
                <path d="M7.5 1v13M1 7.5h13" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              </svg>
            </button>

            <div class="flex items-center gap-1">
              <!-- Send button -->
              <button
                class="h-7 px-3 rounded-lg flex items-center justify-center transition-all duration-150 font-medium text-[12px]"
                [ngClass]="{
                  'bg-gradient-to-r from-[#c97b4b] to-[#b56d3f] text-white hover:shadow-lg hover:shadow-[#c97b4b]/20': userInput.trim() && !isGenerating,
                  'bg-[#e8e3db] text-[#a89e94] cursor-not-allowed': !userInput.trim() || isGenerating
                }"
                [disabled]="!userInput.trim() || isGenerating"
                (click)="sendMessage()"
              >
                Send
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.3s ease-out;
  }

  .scrollbar-thin::-webkit-scrollbar {
    width: 6px;
  }

  .scrollbar-thin::-webkit-scrollbar-track {
    background: transparent;
  }

  .scrollbar-thin::-webkit-scrollbar-thumb {
    background: #d4ccc2;
    border-radius: 3px;
  }

  .scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background: #c8c0b6;
  }
</style>