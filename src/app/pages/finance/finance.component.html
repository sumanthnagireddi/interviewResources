<div class="max-w-5xl mx-auto px-2 sm:px-4 py-4 sm:py-6">

  <!-- =================== HEADER =================== -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
        <span class="material-symbols-outlined text-accent text-3xl" style="font-variation-settings: 'FILL' 1;">
          account_balance_wallet
        </span>
        Finance Tracker
      </h1>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Track, categorize and manage your monthly spending</p>
    </div>
    <div class="flex items-center gap-2">
      <button (click)="openBudgetSettings()"
              class="px-4 py-2 rounded-xl text-sm font-medium border border-gray-200 dark:border-slate-700
                     text-gray-700 dark:text-gray-300 hover:border-accent hover:text-accent transition-all flex items-center gap-2">
        <span class="material-symbols-outlined text-lg">settings</span>
        Budget
      </button>
      <button (click)="openAddForm()"
              class="px-4 py-2 rounded-xl text-sm font-medium text-white btn-accent shadow-lg hover:shadow-xl
                     transition-all flex items-center gap-2">
        <span class="material-symbols-outlined text-lg">add</span>
        Add Expense
      </button>
    </div>
  </div>

  <!-- =================== MONTH NAVIGATOR =================== -->
  <div class="flex items-center justify-center gap-4 mb-6">
    <button (click)="prevMonth()"
            class="w-9 h-9 rounded-xl flex items-center justify-center border border-gray-200 dark:border-slate-700
                   hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors">
      <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">chevron_left</span>
    </button>
    <span class="text-lg font-semibold text-gray-900 dark:text-white min-w-[180px] text-center">
      {{ monthLabel() }}
    </span>
    <button (click)="nextMonth()"
            class="w-9 h-9 rounded-xl flex items-center justify-center border border-gray-200 dark:border-slate-700
                   hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors">
      <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">chevron_right</span>
    </button>
  </div>

  <!-- =================== BUDGET ALERT =================== -->
  @if (isOverBudget()) {
    <div class="mb-6 p-4 rounded-2xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 flex items-center gap-3">
      <span class="material-symbols-outlined text-red-500 text-2xl" style="font-variation-settings: 'FILL' 1;">warning</span>
      <div>
        <p class="text-sm font-semibold text-red-700 dark:text-red-400">Over Budget!</p>
        <p class="text-xs text-red-600 dark:text-red-400/80">You've exceeded your monthly budget by
          {{ formatCurrency(monthSummary().totalSpent - monthSummary().budget) }}</p>
      </div>
    </div>
  }
  @if (isNearAlert()) {
    <div class="mb-6 p-4 rounded-2xl bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 flex items-center gap-3">
      <span class="material-symbols-outlined text-amber-500 text-2xl" style="font-variation-settings: 'FILL' 1;">info</span>
      <div>
        <p class="text-sm font-semibold text-amber-700 dark:text-amber-400">Budget Alert</p>
        <p class="text-xs text-amber-600 dark:text-amber-400/80">You've used {{ monthSummary().percentUsed }}% of your monthly budget</p>
      </div>
    </div>
  }

  <!-- =================== SUMMARY CARDS =================== -->
  <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-6">
    <!-- Total Spent -->
    <div class="p-4 sm:p-5 rounded-2xl bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 shadow-sm">
      <div class="flex items-center gap-2 mb-2">
        <div class="w-8 h-8 rounded-lg bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
          <span class="material-symbols-outlined text-red-500 text-lg">trending_up</span>
        </div>
        <span class="text-xs text-gray-500 dark:text-gray-400 font-medium">Spent</span>
      </div>
      <p class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">
        {{ formatCurrency(monthSummary().totalSpent) }}
      </p>
    </div>

    <!-- Budget -->
    <div class="p-4 sm:p-5 rounded-2xl bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 shadow-sm">
      <div class="flex items-center gap-2 mb-2">
        <div class="w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
          <span class="material-symbols-outlined text-blue-500 text-lg">account_balance</span>
        </div>
        <span class="text-xs text-gray-500 dark:text-gray-400 font-medium">Budget</span>
      </div>
      <p class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">
        {{ currentBudget().monthlyBudget > 0 ? formatCurrency(currentBudget().monthlyBudget) : 'Not set' }}
      </p>
    </div>

    <!-- Remaining -->
    <div class="p-4 sm:p-5 rounded-2xl bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 shadow-sm">
      <div class="flex items-center gap-2 mb-2">
        <div class="w-8 h-8 rounded-lg bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
          <span class="material-symbols-outlined text-green-500 text-lg">savings</span>
        </div>
        <span class="text-xs text-gray-500 dark:text-gray-400 font-medium">Remaining</span>
      </div>
      <p class="text-xl sm:text-2xl font-bold"
         [ngClass]="monthSummary().remaining < 0 ? 'text-red-500' : 'text-green-600 dark:text-green-400'">
        {{ currentBudget().monthlyBudget > 0 ? formatCurrency(monthSummary().remaining) : '—' }}
      </p>
    </div>

    <!-- Transactions Count -->
    <div class="p-4 sm:p-5 rounded-2xl bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 shadow-sm">
      <div class="flex items-center gap-2 mb-2">
        <div class="w-8 h-8 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
          <span class="material-symbols-outlined text-purple-500 text-lg">receipt</span>
        </div>
        <span class="text-xs text-gray-500 dark:text-gray-400 font-medium">Transactions</span>
      </div>
      <p class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">
        {{ currentMonthExpenses().length }}
      </p>
    </div>
  </div>

  <!-- =================== PROGRESS BAR =================== -->
  @if (currentBudget().monthlyBudget > 0) {
    <div class="mb-6 p-4 sm:p-5 rounded-2xl bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 shadow-sm">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Monthly Progress</span>
        <span class="text-sm font-bold" [ngClass]="monthSummary().percentUsed > 100 ? 'text-red-500' : 'text-gray-900 dark:text-white'">
          {{ monthSummary().percentUsed }}%
        </span>
      </div>
      <div class="w-full h-3 bg-gray-100 dark:bg-slate-700 rounded-full overflow-hidden">
        <div class="h-full rounded-full transition-all duration-500"
             [ngClass]="getProgressColor()"
             [style.width.%]="monthSummary().percentUsed > 100 ? 100 : monthSummary().percentUsed">
        </div>
      </div>
      <div class="flex justify-between mt-2 text-xs text-gray-500 dark:text-gray-400">
        <span>{{ formatCurrency(monthSummary().totalSpent) }} spent</span>
        <span>{{ formatCurrency(currentBudget().monthlyBudget) }} budget</span>
      </div>
    </div>
  }

  <!-- =================== TABS =================== -->
  <div class="flex items-center gap-1 mb-6 border-b border-gray-200 dark:border-slate-700 overflow-x-auto">
    <button (click)="activeTab.set('overview')"
            class="px-4 py-2.5 text-sm font-medium whitespace-nowrap transition-colors border-b-2 -mb-px"
            [ngClass]="activeTab() === 'overview'
              ? 'border-accent text-accent'
              : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'">
      Overview
    </button>
    <button (click)="activeTab.set('transactions')"
            class="px-4 py-2.5 text-sm font-medium whitespace-nowrap transition-colors border-b-2 -mb-px"
            [ngClass]="activeTab() === 'transactions'
              ? 'border-accent text-accent'
              : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'">
      Transactions
    </button>
    <button (click)="activeTab.set('categories')"
            class="px-4 py-2.5 text-sm font-medium whitespace-nowrap transition-colors border-b-2 -mb-px"
            [ngClass]="activeTab() === 'categories'
              ? 'border-accent text-accent'
              : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'">
      Categories
    </button>
    <button (click)="activeTab.set('sms')"
            class="px-4 py-2.5 text-sm font-medium whitespace-nowrap transition-colors border-b-2 -mb-px flex items-center gap-1.5"
            [ngClass]="activeTab() === 'sms'
              ? 'border-accent text-accent'
              : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'">
      <span class="material-symbols-outlined text-base">sms</span>
      SMS Analyzer
    </button>
  </div>

  <!-- =================== TAB: OVERVIEW =================== -->
  @if (activeTab() === 'overview') {
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">

      <!-- Category Breakdown -->
      <div class="p-4 sm:p-5 rounded-2xl bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 shadow-sm">
        <h3 class="text-base font-semibold text-gray-900 dark:text-white mb-4">Spending by Category</h3>
        @if (categoryBreakdown().length > 0) {
          <div class="space-y-3">
            @for (item of categoryBreakdown(); track item.category) {
              <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-lg flex items-center justify-center flex-shrink-0"
                     [ngClass]="item.config.color">
                  <span class="material-symbols-outlined text-lg" [ngClass]="item.config.textColor">
                    {{ item.config.icon }}
                  </span>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex items-center justify-between mb-1">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">{{ item.config.label }}</span>
                    <span class="text-sm font-semibold text-gray-900 dark:text-white">{{ formatCurrency(item.total) }}</span>
                  </div>
                  <div class="w-full h-1.5 bg-gray-100 dark:bg-slate-700 rounded-full overflow-hidden">
                    <div class="h-full rounded-full bg-accent transition-all duration-300"
                         [style.width.%]="monthSummary().totalSpent > 0 ? (item.total / monthSummary().totalSpent) * 100 : 0">
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="text-center py-8">
            <span class="material-symbols-outlined text-4xl text-gray-300 dark:text-gray-600">pie_chart</span>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">No spending data this month</p>
          </div>
        }
      </div>

      <!-- Recent Transactions -->
      <div class="p-4 sm:p-5 rounded-2xl bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 shadow-sm">
        <h3 class="text-base font-semibold text-gray-900 dark:text-white mb-4">Recent Transactions</h3>
        @if (currentMonthExpenses().length > 0) {
          <div class="space-y-2">
            @for (expense of currentMonthExpenses().slice(0, 5); track expense.id) {
              <div class="flex items-center gap-3 p-2.5 rounded-xl hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors">
                <div class="w-9 h-9 rounded-lg flex items-center justify-center flex-shrink-0"
                     [ngClass]="getCategoryConfig(expense.category).color">
                  <span class="material-symbols-outlined text-lg" [ngClass]="getCategoryConfig(expense.category).textColor">
                    {{ getCategoryConfig(expense.category).icon }}
                  </span>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-gray-900 dark:text-white truncate">{{ expense.title }}</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">{{ expense.date | date:'mediumDate' }}</p>
                </div>
                <span class="text-sm font-semibold text-gray-900 dark:text-white flex-shrink-0">
                  -{{ formatCurrency(expense.amount) }}
                </span>
              </div>
            }
          </div>
          @if (currentMonthExpenses().length > 5) {
            <button (click)="activeTab.set('transactions')"
                    class="w-full mt-3 py-2 text-sm font-medium text-accent hover:underline">
              View all {{ currentMonthExpenses().length }} transactions →
            </button>
          }
        } @else {
          <div class="text-center py-8">
            <span class="material-symbols-outlined text-4xl text-gray-300 dark:text-gray-600">receipt_long</span>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">No transactions this month</p>
          </div>
        }
      </div>
    </div>
  }

  <!-- =================== TAB: TRANSACTIONS =================== -->
  @if (activeTab() === 'transactions') {
    <div class="rounded-2xl bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 shadow-sm overflow-hidden">
      @if (currentMonthExpenses().length > 0) {
        <div class="divide-y divide-gray-100 dark:divide-slate-700">
          @for (expense of currentMonthExpenses(); track expense.id) {
            <div class="flex items-center gap-3 px-4 sm:px-5 py-3.5 hover:bg-gray-50 dark:hover:bg-slate-700/30 transition-colors group">
              <div class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0"
                   [ngClass]="getCategoryConfig(expense.category).color">
                <span class="material-symbols-outlined text-xl" [ngClass]="getCategoryConfig(expense.category).textColor">
                  {{ getCategoryConfig(expense.category).icon }}
                </span>
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-gray-900 dark:text-white">{{ expense.title }}</p>
                <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                  <span>{{ expense.date | date:'mediumDate' }}</span>
                  <span class="text-gray-300 dark:text-gray-600">•</span>
                  <span>{{ getCategoryConfig(expense.category).label }}</span>
                </div>
                @if (expense.notes) {
                  <p class="text-xs text-gray-400 dark:text-gray-500 mt-0.5 truncate">{{ expense.notes }}</p>
                }
              </div>
              <span class="text-sm font-bold text-gray-900 dark:text-white flex-shrink-0 mr-2">
                -{{ formatCurrency(expense.amount) }}
              </span>

              <!-- Delete -->
              @if (deleteConfirmId() === expense.id) {
                <div class="flex items-center gap-1 flex-shrink-0">
                  <button (click)="deleteExpense(expense.id)"
                          class="px-2 py-1 text-xs font-medium text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors">
                    Delete
                  </button>
                  <button (click)="cancelDelete()"
                          class="px-2 py-1 text-xs font-medium text-gray-600 dark:text-gray-400 border border-gray-200 dark:border-slate-700 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
                    Cancel
                  </button>
                </div>
              } @else {
                <button (click)="confirmDelete(expense.id)"
                        class="w-8 h-8 rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100
                               hover:bg-red-100 dark:hover:bg-red-900/30 transition-all flex-shrink-0">
                  <span class="material-symbols-outlined text-red-500 text-lg">delete</span>
                </button>
              }
            </div>
          }
        </div>
      } @else {
        <div class="text-center py-16 px-4">
          <span class="material-symbols-outlined text-6xl text-gray-300 dark:text-gray-600 mb-3">receipt_long</span>
          <h3 class="text-base font-medium text-gray-600 dark:text-gray-400 mb-1">No transactions yet</h3>
          <p class="text-sm text-gray-500 dark:text-gray-500 mb-4">Start tracking your expenses</p>
          <button (click)="openAddForm()"
                  class="px-4 py-2 rounded-xl text-sm font-medium text-white btn-accent">
            Add your first expense
          </button>
        </div>
      }
    </div>
  }

  <!-- =================== TAB: CATEGORIES =================== -->
  @if (activeTab() === 'categories') {
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3">
      @for (cat of categories; track cat.key) {
        <div class="p-4 rounded-2xl bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 shadow-sm
                    hover:shadow-md hover:border-accent/30 transition-all text-center">
          <div class="w-12 h-12 rounded-xl mx-auto mb-3 flex items-center justify-center"
               [ngClass]="cat.color">
            <span class="material-symbols-outlined text-2xl" [ngClass]="cat.textColor">
              {{ cat.icon }}
            </span>
          </div>
          <p class="text-sm font-medium text-gray-900 dark:text-white mb-1">{{ cat.label }}</p>
          <p class="text-lg font-bold text-gray-900 dark:text-white">
            {{ formatCurrency(getCategoryTotal(cat.key)) }}
          </p>
        </div>
      }
    </div>
  }


  <!-- =================== TAB: SMS ANALYZER =================== -->
  @if (activeTab() === 'sms') {
    <div class="space-y-4">

      <!-- Input Section -->
      <div class="p-4 sm:p-5 rounded-2xl bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 shadow-sm">
        <h3 class="text-base font-semibold text-gray-900 dark:text-white mb-1 flex items-center gap-2">
          <span class="material-symbols-outlined text-accent">sms</span>
          Paste Your SMS Messages
        </h3>
        <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">
          Copy bank SMS messages from your phone and paste them here. The analyzer will extract amounts, merchants and dates automatically.
        </p>
        <textarea [ngModel]="smsRawText()" (ngModelChange)="smsRawText.set($event)"
                  rows="6" placeholder="Paste one or more SMS messages here...

Example:
INR 450.00 debited from A/c XX1234 on 15-Jan-2026 to SWIGGY. Avl Bal: INR 12,345.00
Rs.1200 spent on HDFC Card ending 5678 at AMAZON on 20/01/2026"
                  class="w-full px-4 py-3 rounded-xl border border-gray-200 dark:border-slate-700
                         bg-gray-50 dark:bg-slate-900 text-gray-900 dark:text-white text-sm
                         focus:outline-none focus:ring-2 focus:ring-accent/50 focus:border-accent
                         transition-all resize-none font-mono">
        </textarea>
        <div class="flex items-center gap-3 mt-3">
          <button (click)="analyzeSms()"
                  [disabled]="!smsRawText().trim()"
                  class="px-5 py-2.5 rounded-xl text-sm font-medium text-white btn-accent
                         disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center gap-2">
            <span class="material-symbols-outlined text-lg">analytics</span>
            Analyze Messages
          </button>
          @if (parsedTransactions().length > 0) {
            <button (click)="clearSmsResults()"
                    class="px-4 py-2.5 rounded-xl text-sm font-medium text-gray-600 dark:text-gray-400
                           border border-gray-200 dark:border-slate-700 hover:bg-gray-100 dark:hover:bg-slate-700 transition-all">
              Clear Results
            </button>
          }
        </div>
      </div>

      <!-- Parsed Results -->
      @if (parsedTransactions().length > 0) {
        <div class="p-4 sm:p-5 rounded-2xl bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 shadow-sm">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-base font-semibold text-gray-900 dark:text-white flex items-center gap-2">
              <span class="material-symbols-outlined text-green-500">checklist</span>
              Parsed Transactions ({{ parsedTransactions().length }})
            </h3>
            <div class="flex items-center gap-2">
              <button (click)="toggleAllSms(true)"
                      class="px-3 py-1.5 rounded-lg text-xs font-medium text-accent border border-accent/30
                             hover:bg-accent/10 transition-all">
                Select All
              </button>
              <button (click)="toggleAllSms(false)"
                      class="px-3 py-1.5 rounded-lg text-xs font-medium text-gray-500 border border-gray-200 dark:border-slate-700
                             hover:bg-gray-100 dark:hover:bg-slate-700 transition-all">
                Deselect
              </button>
            </div>
          </div>

          <div class="space-y-2 max-h-[50vh] overflow-y-auto">
            @for (txn of parsedTransactions(); track txn.id) {
              <div class="flex items-start gap-3 p-3 rounded-xl border transition-all"
                   [ngClass]="txn.selected
                     ? 'border-accent/40 bg-accent/5'
                     : 'border-gray-200 dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700/30'">

                <!-- Checkbox -->
                <button (click)="toggleSmsSelection(txn.id)"
                        class="mt-0.5 w-5 h-5 rounded flex-shrink-0 border-2 flex items-center justify-center transition-all"
                        [ngClass]="txn.selected
                          ? 'border-accent bg-accent text-white'
                          : 'border-gray-300 dark:border-slate-600'">
                  @if (txn.selected) {
                    <span class="material-symbols-outlined text-sm">check</span>
                  }
                </button>

                <!-- Details -->
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-sm font-semibold text-gray-900 dark:text-white">{{ txn.merchant }}</span>
                    <span class="px-2 py-0.5 rounded-full text-[10px] font-medium"
                          [ngClass]="txn.type === 'debit' ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' : 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'">
                      {{ txn.type === 'debit' ? 'Debit' : 'Credit' }}
                    </span>
                  </div>
                  <div class="flex items-center gap-2 mt-1 text-xs text-gray-500 dark:text-gray-400">
                    <span>{{ txn.date | date:'mediumDate' }}</span>
                    <span class="text-gray-300 dark:text-gray-600">•</span>
                    <!-- Category selector -->
                    <select [ngModel]="txn.category" (ngModelChange)="updateSmsCategory(txn.id, $event)"
                            class="bg-transparent text-xs font-medium text-accent border-none outline-none cursor-pointer p-0">
                      @for (cat of categories; track cat.key) {
                        <option [value]="cat.key">{{ cat.label }}</option>
                      }
                    </select>
                  </div>
                  <p class="text-[11px] text-gray-400 dark:text-gray-500 mt-1 truncate">{{ txn.rawText }}</p>
                </div>

                <!-- Amount -->
                <span class="text-sm font-bold flex-shrink-0"
                      [ngClass]="txn.type === 'debit' ? 'text-red-500' : 'text-green-500'">
                  {{ txn.type === 'debit' ? '-' : '+' }}{{ formatCurrency(txn.amount) }}
                </span>
              </div>
            }
          </div>

          <!-- Import Bar -->
          @if (selectedSmsCount() > 0) {
            <div class="mt-4 p-3 rounded-xl bg-accent/10 border border-accent/30 flex items-center justify-between">
              <div class="text-sm">
                <span class="font-semibold text-accent">{{ selectedSmsCount() }}</span>
                <span class="text-gray-600 dark:text-gray-400"> transactions selected • </span>
                <span class="font-semibold text-gray-900 dark:text-white">{{ formatCurrency(selectedSmsTotal()) }}</span>
              </div>
              <button (click)="importSelectedSms()"
                      [disabled]="smsImporting()"
                      class="px-4 py-2 rounded-xl text-sm font-medium text-white btn-accent flex items-center gap-2
                             disabled:opacity-50 transition-all">
                <span class="material-symbols-outlined text-lg">download</span>
                Import Selected
              </button>
            </div>
          }
        </div>
      }

      <!-- Empty State -->
      @if (parsedTransactions().length === 0 && !smsRawText().trim()) {
        <div class="text-center py-12 px-4">
          <span class="material-symbols-outlined text-6xl text-gray-300 dark:text-gray-600 mb-3">smartphone</span>
          <h3 class="text-base font-medium text-gray-600 dark:text-gray-400 mb-1">Import from SMS</h3>
          <p class="text-sm text-gray-500 dark:text-gray-500 max-w-md mx-auto">
            Copy your bank/payment SMS messages from your phone and paste them above.
            The analyzer supports most Indian bank formats (HDFC, SBI, ICICI, Axis, etc.)
          </p>
        </div>
      }
    </div>
  }


  <!-- =================== ADD EXPENSE MODAL =================== -->
  @if (showAddForm()) {
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-end sm:items-center justify-center p-0 sm:p-4"
         (click)="showAddForm.set(false)">
      <div class="w-full sm:max-w-lg bg-white dark:bg-slate-900 sm:rounded-2xl rounded-t-2xl shadow-2xl border border-gray-200 dark:border-slate-700 overflow-hidden"
           (click)="$event.stopPropagation()">

        <!-- Modal Header -->
        <div class="flex items-center justify-between px-5 py-4 border-b border-gray-200 dark:border-slate-700">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
            <span class="material-symbols-outlined text-accent">add_card</span>
            Add Expense
          </h2>
          <button (click)="showAddForm.set(false)"
                  class="w-8 h-8 rounded-lg flex items-center justify-center hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors">
            <span class="material-symbols-outlined text-gray-500">close</span>
          </button>
        </div>

        <!-- Modal Body -->
        <div class="p-5 space-y-4 max-h-[70vh] overflow-y-auto">

          <!-- Title -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Title</label>
            <input type="text" [(ngModel)]="newExpense.title" placeholder="e.g. Grocery shopping"
                   class="w-full px-4 py-2.5 rounded-xl border border-gray-200 dark:border-slate-700
                          bg-white dark:bg-slate-800 text-gray-900 dark:text-white text-sm
                          focus:outline-none focus:ring-2 focus:ring-accent/50 focus:border-accent transition-all"
                   autofocus />
          </div>

          <!-- Amount -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Amount (₹)</label>
            <input type="number" [(ngModel)]="newExpense.amount" placeholder="0.00" min="0"
                   class="w-full px-4 py-2.5 rounded-xl border border-gray-200 dark:border-slate-700
                          bg-white dark:bg-slate-800 text-gray-900 dark:text-white text-sm
                          focus:outline-none focus:ring-2 focus:ring-accent/50 focus:border-accent transition-all" />
          </div>

          <!-- Category -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Category</label>
            <div class="grid grid-cols-5 gap-2">
              @for (cat of categories; track cat.key) {
                <button (click)="newExpense.category = cat.key"
                        class="flex flex-col items-center gap-1 p-2 rounded-xl border transition-all text-center"
                        [ngClass]="newExpense.category === cat.key
                          ? 'border-accent bg-accent/10 ring-2 ring-accent/30'
                          : 'border-gray-200 dark:border-slate-700 hover:border-gray-300 dark:hover:border-slate-600'">
                  <span class="material-symbols-outlined text-lg" [ngClass]="cat.textColor">
                    {{ cat.icon }}
                  </span>
                  <span class="text-[10px] font-medium text-gray-600 dark:text-gray-400 leading-tight line-clamp-1">{{ cat.label }}</span>
                </button>
              }
            </div>
          </div>

          <!-- Date -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Date</label>
            <input type="date" [(ngModel)]="newExpense.date"
                   class="w-full px-4 py-2.5 rounded-xl border border-gray-200 dark:border-slate-700
                          bg-white dark:bg-slate-800 text-gray-900 dark:text-white text-sm
                          focus:outline-none focus:ring-2 focus:ring-accent/50 focus:border-accent transition-all" />
          </div>

          <!-- Notes -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Notes (optional)</label>
            <textarea [(ngModel)]="newExpense.notes" rows="2" placeholder="Add any details..."
                      class="w-full px-4 py-2.5 rounded-xl border border-gray-200 dark:border-slate-700
                             bg-white dark:bg-slate-800 text-gray-900 dark:text-white text-sm resize-none
                             focus:outline-none focus:ring-2 focus:ring-accent/50 focus:border-accent transition-all">
            </textarea>
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex items-center gap-3 px-5 py-4 border-t border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-800/50">
          <button (click)="showAddForm.set(false)"
                  class="flex-1 px-4 py-2.5 rounded-xl text-sm font-medium text-gray-700 dark:text-gray-300
                         border border-gray-200 dark:border-slate-700 hover:bg-gray-100 dark:hover:bg-slate-700 transition-all">
            Cancel
          </button>
          <button (click)="submitExpense()"
                  [disabled]="!newExpense.title.trim() || newExpense.amount <= 0"
                  class="flex-1 px-4 py-2.5 rounded-xl text-sm font-medium text-white btn-accent
                         disabled:opacity-50 disabled:cursor-not-allowed transition-all">
            Add Expense
          </button>
        </div>
      </div>
    </div>
  }


  <!-- =================== BUDGET SETTINGS MODAL =================== -->
  @if (showBudgetSettings()) {
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-end sm:items-center justify-center p-0 sm:p-4"
         (click)="showBudgetSettings.set(false)">
      <div class="w-full sm:max-w-md bg-white dark:bg-slate-900 sm:rounded-2xl rounded-t-2xl shadow-2xl border border-gray-200 dark:border-slate-700 overflow-hidden"
           (click)="$event.stopPropagation()">

        <!-- Modal Header -->
        <div class="flex items-center justify-between px-5 py-4 border-b border-gray-200 dark:border-slate-700">
          <div>
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
              <span class="material-symbols-outlined text-accent">tune</span>
              Budget Settings
            </h2>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 ml-8">for {{ monthLabel() }}</p>
          </div>
          <button (click)="showBudgetSettings.set(false)"
                  class="w-8 h-8 rounded-lg flex items-center justify-center hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors">
            <span class="material-symbols-outlined text-gray-500">close</span>
          </button>
        </div>

        <!-- Modal Body -->
        <div class="p-5 space-y-5">

          <!-- Copy from previous month -->
          <button (click)="copyBudgetFromPrevMonth()"
                  class="w-full px-4 py-2.5 rounded-xl text-sm font-medium border border-dashed border-gray-300
                         dark:border-slate-600 text-gray-600 dark:text-gray-400 hover:border-accent hover:text-accent
                         hover:bg-accent/5 transition-all flex items-center justify-center gap-2">
            <span class="material-symbols-outlined text-lg">content_copy</span>
            Copy budget from previous month
          </button>

          <!-- Monthly Budget -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Monthly Budget (₹)</label>
            <input type="number" [(ngModel)]="budgetForm.monthlyBudget" placeholder="e.g. 50000" min="0"
                   class="w-full px-4 py-2.5 rounded-xl border border-gray-200 dark:border-slate-700
                          bg-white dark:bg-slate-800 text-gray-900 dark:text-white text-sm
                          focus:outline-none focus:ring-2 focus:ring-accent/50 focus:border-accent transition-all" />
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Set your spending limit for this month</p>
          </div>

          <!-- Alert Threshold -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">
              Alert Threshold: {{ budgetForm.alertThreshold }}%
            </label>
            <input type="range" [(ngModel)]="budgetForm.alertThreshold" min="50" max="100" step="5"
                   class="w-full h-2 bg-gray-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-accent" />
            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
              <span>50%</span>
              <span>100%</span>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
              Get alerted when your spending reaches this percentage of your budget
            </p>
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex items-center gap-3 px-5 py-4 border-t border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-800/50">
          <button (click)="showBudgetSettings.set(false)"
                  class="flex-1 px-4 py-2.5 rounded-xl text-sm font-medium text-gray-700 dark:text-gray-300
                         border border-gray-200 dark:border-slate-700 hover:bg-gray-100 dark:hover:bg-slate-700 transition-all">
            Cancel
          </button>
          <button (click)="saveBudget()"
                  class="flex-1 px-4 py-2.5 rounded-xl text-sm font-medium text-white btn-accent transition-all">
            Save for {{ monthLabel() }}
          </button>
        </div>
      </div>
    </div>
  }

</div>
